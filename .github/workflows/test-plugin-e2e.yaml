name: E2E tests

on:
  pull_request:
  workflow_dispatch:
    inputs:
      logs:
        description: "Set 1 to activate full logs"
        required: false
        default: "0"

jobs:
  plugin-build:
    runs-on: [self-hosted, nxlab, packer]
    outputs:
      test-list: ${{ steps.test-list.outputs.list}}

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v6.0.2

      - name: Setup `golang`
        uses: actions/setup-go@v6
        with:
          go-version-file: go.mod

      - name: Build packer plugin
        run: |
          cd $GITHUB_WORKSPACE
          make build

      - uses: actions/upload-artifact@v6
        with:
          name: packer-plugin-nutanix
          path: packer-plugin-nutanix
          retention-days: 7

      - name: build test list
        id: test-list
        run: echo "list=$(ls test/e2e | jq -R -s -c 'split("\n")[:-1]')" >> $GITHUB_OUTPUT

  e2e:
    name: E2E test
    needs: plugin-build

    strategy:
      matrix:
        test: ${{fromJSON(needs.plugin-build.outputs.test-list)}}

    runs-on: [self-hosted, nxlab, packer]
    defaults:
      run:
        working-directory: test/e2e/${{ matrix.test}}

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v6.0.2

      - name: Setup `packer`
        uses: hashicorp/setup-packer@main
        id: setup-packer

      - name: Setup `xorriso`
        run: |
          sudo apt update -y
          sudo apt install -y xorriso

      - uses: actions/download-artifact@v7
        with:
          name: packer-plugin-nutanix
          path: /tmp

      - name: Fix plugin permissions
        run: |
          chmod +x /tmp/packer-plugin-nutanix

      - name: Install plugin
        run: |
          packer plugins install --path /tmp/packer-plugin-nutanix "github.com/nutanix-cloud-native/nutanix"

      - name: Debug V4 API and resources
        run: |
          BASE="https://${PKR_VAR_nutanix_endpoint}:${PKR_VAR_nutanix_port}"
          AUTH="${PKR_VAR_nutanix_username}:${PKR_VAR_nutanix_password}"
          
          echo "=== Testing API Version Negotiation ==="
          curl -sk -u "$AUTH" "$BASE/api/clustermgmt/unversioned/info" | jq -r '.supportedVersions' 2>/dev/null || echo "Version info failed"
          
          echo ""
          echo "=== Checking cluster: ${PKR_VAR_nutanix_cluster} ==="
          CLUSTER_RESULT=$(curl -sk -u "$AUTH" "$BASE/api/clustermgmt/v4.0/config/clusters?\$filter=name%20eq%20'${PKR_VAR_nutanix_cluster}'" 2>/dev/null)
          echo "$CLUSTER_RESULT" | jq -r '.data[] | {name, extId}' 2>/dev/null || echo "Cluster not found"
          CLUSTER_UUID=$(echo "$CLUSTER_RESULT" | jq -r '.data[0].extId' 2>/dev/null)
          echo "Cluster UUID: $CLUSTER_UUID"
          
          echo ""
          echo "=== Checking subnet: ${PKR_VAR_nutanix_subnet} ==="
          SUBNET_RESULT=$(curl -sk -u "$AUTH" "$BASE/api/networking/v4.0/config/subnets?\$filter=name%20eq%20'${PKR_VAR_nutanix_subnet}'" 2>/dev/null)
          echo "$SUBNET_RESULT" | jq -r '.data[] | {name, extId, subnetType, clusterReference}' 2>/dev/null || echo "Subnet not found"
          
          echo ""
          echo "=== Test external URL connectivity from PC ==="
          echo "Checking if PC can reach cloud.centos.org..."
          curl -sk -u "$AUTH" -X POST "$BASE/api/vmm/v4.0/content/images" \
            -H "Content-Type: application/json" \
            -d '{"name":"connectivity-test-delete-me","type":"DISK_IMAGE","source":{"$objectType":"vmm.v4.content.UrlSource","url":"https://cloud.centos.org/centos/7/images/CentOS-7-x86_64-GenericCloud-2111.qcow2"}}' \
            | jq -r '{taskExtId: .data.extId, message: .error.message}' 2>/dev/null || echo "Image creation test failed"
          
          echo ""
          echo "=== Checking category VALUES ==="
          echo "TemplateType=Vm:"
          curl -sk -u "$AUTH" "$BASE/api/prism/v4.0/config/categories?\$filter=key%20eq%20'TemplateType'%20and%20value%20eq%20'Vm'" | jq -r '.data[] | {key, value, extId}' 2>/dev/null || echo "Not found"
          echo "Environment=Testing:"
          curl -sk -u "$AUTH" "$BASE/api/prism/v4.0/config/categories?\$filter=key%20eq%20'Environment'%20and%20value%20eq%20'Testing'" | jq -r '.data[] | {key, value, extId}' 2>/dev/null || echo "Not found"
          
          echo ""
          echo "=== Recent failed tasks (last 5) ==="
          curl -sk -u "$AUTH" "$BASE/api/prism/v4.0/config/tasks?\$filter=status%20eq%20'FAILED'&\$top=5&\$orderby=completedTime%20desc" | jq -r '.data[] | {extId, operation: .operation, errorMessages: .errorMessages}' 2>/dev/null || echo "Task query failed"
          
          echo ""
          echo "=== Check existing CentOS images ==="
          curl -sk -u "$AUTH" "$BASE/api/vmm/v4.0/content/images?\$filter=contains(name,'CentOS')" | jq -r '.data[] | {name, extId, sizeBytes}' 2>/dev/null || echo "Image query failed"

      - name: Run `packer init`
        id: init
        run: |
          packer init .

      - name: Run `packer validate`
        id: validate
        run: packer validate -var "test=${{ matrix.test}}" .
        env:
          PACKER_LOG: 1

      - name: Run `packer build`
        id: build
        run: packer build -var "test=${{ matrix.test}}" .
        env:
          PACKER_LOG: 1

  results:
    if: ${{ always() }}
    runs-on: [self-hosted, nxlab, packer]
    name: Final E2E results
    needs: [e2e]
    steps:
      - run: |
          result="${{ needs.e2e.result }}"
          if [[ $result == "success" || $result == "skipped" ]]; then
            exit 0
          else
            exit 1
          fi

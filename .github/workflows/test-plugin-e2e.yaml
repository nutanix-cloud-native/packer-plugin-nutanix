name: E2E tests

on:
  pull_request:
  workflow_dispatch:
    inputs:
      logs:
        description: "Set 1 to activate full logs"
        required: false
        default: "0"

jobs:
  plugin-build:
    runs-on: [self-hosted, nxlab, packer]
    outputs:
      test-list: ${{ steps.test-list.outputs.list}}

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v6.0.1

      - name: Setup `golang`
        uses: actions/setup-go@v6
        with:
          go-version-file: go.mod

      - name: Build packer plugin
        run: |
          cd $GITHUB_WORKSPACE
          make build

      - uses: actions/upload-artifact@v6
        with:
          name: packer-plugin-nutanix
          path: packer-plugin-nutanix
          retention-days: 7

      - name: build test list
        id: test-list
        run: echo "list=$(ls test/e2e | jq -R -s -c 'split("\n")[:-1]')" >> $GITHUB_OUTPUT

  e2e:
    name: E2E test
    needs: plugin-build

    strategy:
      matrix:
        test: ${{fromJSON(needs.plugin-build.outputs.test-list)}}

    runs-on: [self-hosted, nxlab, packer]
    defaults:
      run:
        working-directory: test/e2e/${{ matrix.test}}

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v6.0.1

      - name: Setup `packer`
        uses: hashicorp/setup-packer@main
        id: setup-packer

      - name: Setup `xorriso`
        run: |
          sudo apt update -y
          sudo apt install -y xorriso

      - uses: actions/download-artifact@v7
        with:
          name: packer-plugin-nutanix
          path: /tmp

      - name: Fix plugin permissions
        run: |
          chmod +x /tmp/packer-plugin-nutanix

      - name: Install plugin
        run: |
          packer plugins install --path /tmp/packer-plugin-nutanix "github.com/nutanix-cloud-native/nutanix"

      - name: Debug V4 API and resources
        run: |
          BASE="https://${PKR_VAR_nutanix_endpoint}:${PKR_VAR_nutanix_port}"
          AUTH="${PKR_VAR_nutanix_username}:${PKR_VAR_nutanix_password}"
          
          echo "=== Testing V4.1 API ==="
          curl -sk -u "$AUTH" "$BASE/api/clustermgmt/v4.1/config/clusters?\$top=1" | head -c 300
          
          echo ""
          echo "=== Checking cluster: ${PKR_VAR_nutanix_cluster} ==="
          curl -sk -u "$AUTH" "$BASE/api/clustermgmt/v4.1/config/clusters?\$filter=name%20eq%20'${PKR_VAR_nutanix_cluster}'" | jq -r '.data[] | {name, extId}' 2>/dev/null || echo "Cluster not found or jq error"
          
          echo ""
          echo "=== Checking subnet: ${PKR_VAR_nutanix_subnet} ==="
          curl -sk -u "$AUTH" "$BASE/api/networking/v4.0/config/subnets?\$filter=name%20eq%20'${PKR_VAR_nutanix_subnet}'" | jq -r '.data[] | {name, extId, subnetType}' 2>/dev/null || echo "Subnet not found or jq error"
          
          echo ""
          echo "=== Checking subnet cluster association ==="
          curl -sk -u "$AUTH" "$BASE/api/networking/v4.0/config/subnets?\$filter=name%20eq%20'${PKR_VAR_nutanix_subnet}'" | jq -r '.data[] | {name, extId, clusterReference}' 2>/dev/null || echo "Subnet cluster check failed"
          
          echo ""
          echo "=== Checking category VALUES (not just keys) ==="
          echo "Looking for TemplateType=Vm..."
          curl -sk -u "$AUTH" "$BASE/api/prism/v4.0/config/categories?\$filter=key%20eq%20'TemplateType'%20and%20value%20eq%20'Vm'" | jq -r '.data[] | {key, value}' 2>/dev/null || echo "TemplateType=Vm not found"
          echo "Looking for Environment=Testing..."
          curl -sk -u "$AUTH" "$BASE/api/prism/v4.0/config/categories?\$filter=key%20eq%20'Environment'%20and%20value%20eq%20'Testing'" | jq -r '.data[] | {key, value}' 2>/dev/null || echo "Environment=Testing not found"
          
          echo ""
          echo "=== Listing available images (first 5) ==="
          curl -sk -u "$AUTH" "$BASE/api/vmm/v4.0/content/images?\$top=5" | jq -r '.data[] | {name, extId}' 2>/dev/null || echo "Image list failed"

      - name: Run `packer init`
        id: init
        run: |
          packer init .

      - name: Run `packer validate`
        id: validate
        run: packer validate -var "test=${{ matrix.test}}" .
        env:
          PACKER_LOG: ${{ github.event.inputs.logs }}

      - name: Run `packer build`
        id: build
        run: packer build -var "test=${{ matrix.test}}" .
        env:
          PACKER_LOG: ${{ github.event.inputs.logs }}

  results:
    if: ${{ always() }}
    runs-on: [self-hosted, nxlab, packer]
    name: Final E2E results
    needs: [e2e]
    steps:
      - run: |
          result="${{ needs.e2e.result }}"
          if [[ $result == "success" || $result == "skipped" ]]; then
            exit 0
          else
            exit 1
          fi
